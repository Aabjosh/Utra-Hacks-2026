#include <Servo.h>


// Motor Driver 
int ENA = 10;   // PWM speed left motor
int IN1 = 8;
int IN2 = 9;

int ENB = 5;   // PWM speed right motor
int IN3 = 6;
int IN4 = 7;

// IR Line Sensors 
int IR_LEFT  = 2;
int IR_RIGHT = 3;

// Color Sensor 
int S0 = A0;      // Frequency scaling
int S1 = A1;      // Frequency scaling
int S2 = A2;      // Color filter select
int S3 = A3;      // Color filter select
int sensorOut = 4; // Frequency output

// Ultrasonic Sensor 
int TRIG_PIN = 12;
int ECHO_PIN = 13;

// Servos 
Servo clawServo;
Servo ultrasonicServo;  // Servo to rotate ultrasonic sensor
int CLAW_PIN = A3;
int ULTRASONIC_SERVO_PIN = A4;


void setLeftMotor(int speed, bool forward){
  analogWrite(ENA, speed);
  digitalWrite(IN1, forward);
  digitalWrite(IN2, !forward);
}

void setRightMotor(int speed, bool forward){
  analogWrite(ENB, speed);
  digitalWrite(IN3, forward);
  digitalWrite(IN4, !forward);
}

void moveForward(int spd){
  setLeftMotor(spd, true);
  setRightMotor(spd, true);
}

void moveBackward(int spd){
  setLeftMotor(-spd, true);
  setRightMotor(-spd, true);
}

void stopMotors(){
  setLeftMotor(0, true);
  setRightMotor(0, true);
}

void turnLeft(int spd){
  setLeftMotor(spd, false);
  setRightMotor(spd, true);
}

void turnRight(int spd){
  setLeftMotor(spd, true);
  setRightMotor(spd, false);
}

void spin180(int spd){
  setLeftMotor(spd, true);
  setRightMotor(-spd, true);
  delay(1000);
  stopMotors();
}

// MH-B: LOW = black line detected, HIGH = white

void followLine(){
  int left  = digitalRead(IR_LEFT);
  int right = digitalRead(IR_RIGHT);

  if((left == LOW && right == LOW)|| (left == HIGH && right == LOW)){
    turnRight(120);
  }
  else if(left == LOW && right == HIGH){
    turnLeft(120);
  }
}


// Function to read color frequency
int getColorFrequency(char color){
  // Set filter based on color
  if(color == 'R'){
    digitalWrite(S2, LOW);
    digitalWrite(S3, LOW);
  }
  else if(color == 'G'){
    digitalWrite(S2, HIGH);
    digitalWrite(S3, HIGH);
  }
  else if(color == 'B'){
    digitalWrite(S2, LOW);
    digitalWrite(S3, HIGH);
  }
  
  delay(100);  // Let sensor stabilize
  
  // Read frequency (lower = more of that color)
  int frequency = pulseIn(sensorOut, LOW);
  return frequency;
}

String detectColor(){
  int redFreq = getColorFrequency('R');
  int greenFreq = getColorFrequency('G');
  int blueFreq = getColorFrequency('B');
  
  
  // Check for BLACK (all frequencies high/similar)
  if(redFreq > 200 && greenFreq > 200 && blueFreq > 200){
    return "BLACK";
  }
  
  // Check for WHITE (all frequencies low/similar)
  if(redFreq < 50 && greenFreq < 50 && blueFreq < 50){
    return "WHITE";
  }
  
  // Find which color has lowest frequency (most detected)
  if(redFreq < greenFreq && redFreq < blueFreq){
    return "RED";
  }
  else if(greenFreq < redFreq && greenFreq < blueFreq){
    return "GREEN";
  }
  else if(blueFreq < redFreq && blueFreq < greenFreq){
    return "BLUE";
  }
  
  return "WHITE";  // Default
}


long getDistance(){
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  long duration = pulseIn(ECHO_PIN, HIGH, 30000);
  
  if(duration == 0) return 999; // No echo received
  
  return duration * 0.034 / 2;
}

// Scan for obstacles by rotating ultrasonic sensor
long scanForObstacle(){
  long minDistance = 999;
  
  // Scan left
  ultrasonicServo.write(135);
  delay(200);
  long leftDist = getDistance();
  if(leftDist < minDistance) minDistance = leftDist;
  
  // Scan center
  ultrasonicServo.write(90);
  delay(200);
  long centerDist = getDistance();
  if(centerDist < minDistance) minDistance = centerDist;
  
  // Scan right
  ultrasonicServo.write(45);
  delay(200);
  long rightDist = getDistance();
  if(rightDist < minDistance) minDistance = rightDist;
  
  // Return to center
  ultrasonicServo.write(90);
  delay(200);
  
  return minDistance;
}


void dropBox(){
  stopMotors();
  turnRight(120);
  delay(1000);
  stopMotors();
  moveForward(120);
  delay(300);
  clawServo.write(120);   // open claw
  delay(800);
  moveBackward(120);
  delay(300);
  turnLeft(90);
  delay(1000);

}

void getBox(){
  stopMotors();
  turnLeft(120);
  delay(1000);
  stopMotors();
  moveForward(120);
  delay(300);
  clawServo.write(0);   // close claw
  delay(800);
  moveBackward(120);
  delay(300);
  turnRight(90);
  delay(1000);
}

void goToTargetCenter(){
  while(detectColor() != "BLACK"){
    moveForward(10);
  }
  stopMotors();
  delay(400);
}

void obstacleCourse(){
  while(true){
    long d = getDistance();

    if(d < 15){
      // Scan to find best path
      stopMotors();
      delay(100);
      scanForObstacle();
      
      turnRight(130);
      delay(350);
    } else {
      followLine();
    }

    if(detectColor() == "WHITE") break;
  }
}

void setup(){
  pinMode(IN1, OUTPUT); 
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); 
  pinMode(IN4, OUTPUT);
  pinMode(ENA, OUTPUT); 
  pinMode(ENB, OUTPUT);

  pinMode(IR_LEFT, INPUT);
  pinMode(IR_RIGHT, INPUT);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  // TCS3200 setup
  pinMode(S0, OUTPUT);
  pinMode(S1, OUTPUT);
  pinMode(S2, OUTPUT);
  pinMode(S3, OUTPUT);
  pinMode(sensorOut, INPUT);
  
  // Set frequency scaling to 20%
  digitalWrite(S0, HIGH);
  digitalWrite(S1, LOW);

  clawServo.attach(CLAW_PIN);
  ultrasonicServo.attach(ULTRASONIC_SERVO_PIN);
  
  clawServo.write(30);    // closed
  ultrasonicServo.write(90); // center position
  delay(500);
}


void loop(){
  // Detect path split (green/red)
  String color = "";
  // Move to BLUE zone to drop box
  while(detectColor() != "BLUE"){
    followLine();
  }


  getBox();

  if(detectColor() == "GREEN"){
    dropBox();
    while(detectColor() != "BLUE"){
      goToTargetCenter();
    }
    clawServo.write(0);   // close claw
    delay(1000);
    while(detectColor() != "BLUE"){
      moveForward(100);
    }
    stopMotors();
    clawServo.write(120);   // close claw
    moveBackward(100);
    delay(400);
    spin180();
    moveForward(100);
    while(detectColor() != "BLACK"){
      delay(50);
    }
    stopMotors();
    while(detectColor() != "BLUE"){
      followLine();
    }
    getBox();
    while(getDistance()>70){
      followLine();
    }
    turnRight(120);
    delay(300);
    moveForward(100);
    while(getDistance()<100)



  }
  
  
  

  // Do GREEN first (go to target center)
  if(color == "GREEN"){
    goToTargetCenter();
  }

  // Then obstacle course
  obstacleCourse();

  // Return to start (blue)
  while(detectColor() != "BLUE"){
    followLine();
  }

  stopMotors();
}
